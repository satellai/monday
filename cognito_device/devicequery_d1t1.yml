name: API Monitor with Email Alerts

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Monitor API with Smart Alerting
        id: monitor
        env:
          REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          TOKEN_ENDPOINT: ${{ secrets.TOKEN_ENDPOINT }}
          API_URL: ${{ secrets.API_URL }}
        run: |
          python << 'EOF'
          import requests
          import os
          import sys
          import json
          from datetime import datetime
          
          # é…ç½®
          API_URL = os.getenv('API_URL', 'https://icmmdwdp03.execute-api.us-west-1.amazonaws.com/dev/user/query-by-email')
          API_TIMEOUT = 30  # ç§’
          
          def get_access_token_from_refresh():
              """ä½¿ç”¨refresh tokenè·å–æ–°çš„access token"""
              try:
                  refresh_token = os.getenv('REFRESH_TOKEN')
                  client_id = os.getenv('CLIENT_ID')
                  client_secret = os.getenv('CLIENT_SECRET')
                  token_endpoint = os.getenv('TOKEN_ENDPOINT')
                  
                  if not all([refresh_token, client_id, token_endpoint]):
                      raise ValueError("ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡")
                  
                  data = {
                      'grant_type': 'refresh_token',
                      'refresh_token': refresh_token,
                      'client_id': client_id
                  }
                  
                  headers = {
                      'Content-Type': 'application/x-www-form-urlencoded'
                  }
                  
                  auth = (client_id, client_secret) if client_secret else None
                  
                  print(f"ğŸ”„ æ­£åœ¨åˆ·æ–°token... [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}]")
                  response = requests.post(
                      token_endpoint,
                      data=data,
                      headers=headers,
                      auth=auth,
                      timeout=10
                  )
                  
                  response.raise_for_status()
                  token_data = response.json()
                  
                  access_token = token_data.get('access_token')
                  if not access_token:
                      raise ValueError("æœªèƒ½ä»å“åº”ä¸­è·å–access_token")
                  
                  print(f"âœ… Tokenåˆ·æ–°æˆåŠŸ (æœ‰æ•ˆæœŸ: {token_data.get('expires_in', 'N/A')}ç§’)")
                  return access_token
                  
              except Exception as e:
                  print(f"âŒ Tokenåˆ·æ–°å¤±è´¥: {str(e)}")
                  raise
          
          def check_api(access_token):
              """è°ƒç”¨APIå¹¶è¿”å›è¯¦ç»†çŠ¶æ€"""
              result = {
                  'success': False,
                  'status_code': None,
                  'error_type': None,
                  'error_message': None,
                  'response_time': None,
                  'should_alert': False
              }
              
              try:
                  headers = {
                      'Authorization': f'Bearer {access_token}',
                      'User-Agent': 'GitHub-Actions-Monitor',
                      'Accept': '*/*',
                      'Cache-Control': 'no-cache',
                      'Accept-Encoding': 'gzip, deflate, br',
                      'Connection': 'keep-alive'
                  }
                  
                  print(f"\nğŸ“¡ è°ƒç”¨API... [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}]")
                  print(f"URL: {API_URL}")
                  
                  import time
                  start_time = time.time()
                  
                  response = requests.get(
                      API_URL,
                      headers=headers,
                      timeout=API_TIMEOUT
                  )
                  
                  response_time = time.time() - start_time
                  result['response_time'] = response_time
                  result['status_code'] = response.status_code
                  
                  print(f"â±ï¸  å“åº”æ—¶é—´: {response_time:.2f}ç§’")
                  print(f"ğŸ“Š çŠ¶æ€ç : {response.status_code}")
                  
                  # æ ¹æ®çŠ¶æ€ç åˆ†ç±»å¤„ç†
                  if 200 <= response.status_code < 300:
                      # 2xx - æˆåŠŸ
                      result['success'] = True
                      result['should_alert'] = False
                      print(f"âœ… APIè°ƒç”¨æˆåŠŸ")
                      
                      response_preview = response.text[:300]
                      if len(response.text) > 300:
                          response_preview += "..."
                      print(f"å“åº”å†…å®¹: {response_preview}")
                      
                  elif 400 <= response.status_code < 500:
                      # 4xx - å®¢æˆ·ç«¯é”™è¯¯ï¼Œä»…è®°å½•æ—¥å¿—
                      result['success'] = False
                      result['error_type'] = '4xx_client_error'
                      result['error_message'] = f"å®¢æˆ·ç«¯é”™è¯¯ {response.status_code}"
                      result['should_alert'] = False  # 4xxä¸å‘é€é‚®ä»¶
                      
                      print(f"âš ï¸  å®¢æˆ·ç«¯é”™è¯¯ {response.status_code} - ä»…è®°å½•æ—¥å¿—ï¼Œä¸å‘é€å‘Šè­¦")
                      print(f"å“åº”å†…å®¹: {response.text[:500]}")
                      
                  elif 500 <= response.status_code < 600:
                      # 5xx - æœåŠ¡å™¨é”™è¯¯ï¼Œéœ€è¦å‘Šè­¦
                      result['success'] = False
                      result['error_type'] = '5xx_server_error'
                      result['error_message'] = f"æœåŠ¡å™¨é”™è¯¯ {response.status_code}: {response.text[:200]}"
                      result['should_alert'] = True
                      
                      print(f"âŒ æœåŠ¡å™¨é”™è¯¯ {response.status_code} - å°†å‘é€é‚®ä»¶å‘Šè­¦")
                      print(f"å“åº”å†…å®¹: {response.text[:500]}")
                  
                  return result
                  
              except requests.exceptions.Timeout:
                  # è¶…æ—¶é”™è¯¯ï¼Œéœ€è¦å‘Šè­¦
                  result['error_type'] = 'timeout'
                  result['error_message'] = f"APIè°ƒç”¨è¶…æ—¶ï¼ˆè¶…è¿‡{API_TIMEOUT}ç§’ï¼‰"
                  result['should_alert'] = True
                  
                  print(f"âŒ APIè°ƒç”¨è¶…æ—¶ - å°†å‘é€é‚®ä»¶å‘Šè­¦")
                  print(f"è¶…æ—¶è®¾ç½®: {API_TIMEOUT}ç§’")
                  return result
                  
              except requests.exceptions.RequestException as e:
                  # å…¶ä»–ç½‘ç»œé”™è¯¯ï¼Œéœ€è¦å‘Šè­¦
                  result['error_type'] = 'network_error'
                  result['error_message'] = f"ç½‘ç»œé”™è¯¯: {str(e)}"
                  result['should_alert'] = True
                  
                  print(f"âŒ ç½‘ç»œé”™è¯¯ - å°†å‘é€é‚®ä»¶å‘Šè­¦")
                  print(f"é”™è¯¯è¯¦æƒ…: {str(e)}")
                  
                  if hasattr(e, 'response') and e.response is not None:
                      result['status_code'] = e.response.status_code
                      print(f"å“åº”çŠ¶æ€: {e.response.status_code}")
                  
                  return result
          
          def save_result_for_email(result):
              """ä¿å­˜ç»“æœä¾›åç»­æ­¥éª¤ä½¿ç”¨"""
              # å†™å…¥GitHub Actionsè¾“å‡º
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"should_alert={str(result['should_alert']).lower()}\n")
                  f.write(f"error_type={result.get('error_type', '')}\n")
                  f.write(f"error_message={result.get('error_message', '')}\n")
                  f.write(f"status_code={result.get('status_code', 'N/A')}\n")
                  f.write(f"response_time={result.get('response_time', 'N/A')}\n")
          
          def main():
              try:
                  # æ­¥éª¤1: åˆ·æ–°token
                  access_token = get_access_token_from_refresh()
                  
                  # æ­¥éª¤2: è°ƒç”¨API
                  result = check_api(access_token)
                  
                  # æ­¥éª¤3: ä¿å­˜ç»“æœ
                  save_result_for_email(result)
                  
                  print(f"\n{'='*60}")
                  print(f"ç›‘æ§æ‘˜è¦ [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}]")
                  print(f"{'='*60}")
                  print(f"çŠ¶æ€: {'âœ… æˆåŠŸ' if result['success'] else 'âŒ å¤±è´¥'}")
                  print(f"çŠ¶æ€ç : {result['status_code']}")
                  print(f"å“åº”æ—¶é—´: {result['response_time']:.2f}ç§’" if result['response_time'] else "å“åº”æ—¶é—´: N/A")
                  print(f"æ˜¯å¦å‘Šè­¦: {'æ˜¯' if result['should_alert'] else 'å¦'}")
                  if result['error_type']:
                      print(f"é”™è¯¯ç±»å‹: {result['error_type']}")
                  print(f"{'='*60}\n")
                  
                  # å¦‚æœéœ€è¦å‘Šè­¦ï¼Œè¿”å›éé›¶é€€å‡ºç è§¦å‘é‚®ä»¶æ­¥éª¤
                  if result['should_alert']:
                      sys.exit(1)
                  else:
                      sys.exit(0)
                  
              except Exception as e:
                  print(f"\nâŒ ç›‘æ§æ‰§è¡Œå¼‚å¸¸: {str(e)}")
                  # ä¿å­˜å¼‚å¸¸ä¿¡æ¯
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"should_alert=true\n")
                      f.write(f"error_type=exception\n")
                      f.write(f"error_message=ç›‘æ§è„šæœ¬å¼‚å¸¸: {str(e)}\n")
                      f.write(f"status_code=N/A\n")
                  sys.exit(1)
          
          if __name__ == '__main__':
              main()
          EOF
      
      - name: Send Email Alert
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: sherrywangboston@gmail.com
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'ğŸš¨ APIç›‘æ§å‘Šè­¦ - ${{ steps.monitor.outputs.error_type }}'
          to: wangke@satellai.com
          from: sherrywangboston@gmail.com
          body: |
            APIç›‘æ§æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œè¯·åŠæ—¶å¤„ç†ï¼
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“‹ å‘Šè­¦è¯¦æƒ…
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            ğŸ”´ é”™è¯¯ç±»å‹: ${{ steps.monitor.outputs.error_type }}
            ğŸ“Š çŠ¶æ€ç : ${{ steps.monitor.outputs.status_code }}
            â±ï¸  å“åº”æ—¶é—´: ${{ steps.monitor.outputs.response_time }}ç§’
            ğŸ• å‘Šè­¦æ—¶é—´: ${{ github.event.repository.updated_at }}
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“ é”™è¯¯ä¿¡æ¯
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            ${{ steps.monitor.outputs.error_message }}
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ”— ç›¸å…³é“¾æ¥
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            APIåœ°å€: https://icmmdwdp03.execute-api.us-west-1.amazonaws.com/dev/user/query-by-email
            
            æŸ¥çœ‹è¯¦ç»†æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€
            ä»“åº“: ${{ github.repository }}
            åˆ†æ”¯: ${{ github.ref }}
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px 10px 0 0; text-align: center; }
                .content { background: #f7f7f7; padding: 30px; border-radius: 0 0 10px 10px; }
                .alert-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 4px; }
                .error-box { background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 20px 0; border-radius: 4px; }
                .info-box { background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 15px; margin: 20px 0; border-radius: 4px; }
                .detail-row { padding: 10px 0; border-bottom: 1px solid #dee2e6; }
                .detail-label { font-weight: bold; color: #666; display: inline-block; width: 120px; }
                .button { display: inline-block; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; margin-top: 20px; }
                .footer { text-align: center; color: #666; font-size: 12px; margin-top: 20px; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h1>ğŸš¨ APIç›‘æ§å‘Šè­¦</h1>
                  <p>æ£€æµ‹åˆ°å¼‚å¸¸æƒ…å†µï¼Œè¯·åŠæ—¶å¤„ç†</p>
                </div>
                <div class="content">
                  <div class="error-box">
                    <h3>ğŸ”´ é”™è¯¯ç±»å‹: ${{ steps.monitor.outputs.error_type }}</h3>
                  </div>
                  
                  <div class="detail-row">
                    <span class="detail-label">ğŸ“Š çŠ¶æ€ç :</span>
                    <span>${{ steps.monitor.outputs.status_code }}</span>
                  </div>
                  
                  <div class="detail-row">
                    <span class="detail-label">â±ï¸ å“åº”æ—¶é—´:</span>
                    <span>${{ steps.monitor.outputs.response_time }}ç§’</span>
                  </div>
                  
                  <div class="detail-row">
                    <span class="detail-label">ğŸ• å‘Šè­¦æ—¶é—´:</span>
                    <span>${{ github.event.repository.updated_at }}</span>
                  </div>
                  
                  <div class="info-box">
                    <h4>ğŸ“ é”™è¯¯è¯¦æƒ…</h4>
                    <p>${{ steps.monitor.outputs.error_message }}</p>
                  </div>
                  
                  <div class="alert-box">
                    <h4>ğŸ”— APIåœ°å€</h4>
                    <p><code>https://icmmdwdp03.execute-api.us-west-1.amazonaws.com/dev/user/query-by-email</code></p>
                  </div>
                  
                  <center>
                    <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="button">
                      æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
                    </a>
                  </center>
                  
                  <div class="footer">
                    <p>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€</p>
                    <p>ä»“åº“: ${{ github.repository }} | åˆ†æ”¯: ${{ github.ref }}</p>
                  </div>
                </div>
              </div>
            </body>
            </html>